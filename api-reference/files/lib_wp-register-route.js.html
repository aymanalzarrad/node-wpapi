<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/wp-register-route.js - wpapi</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/vendor/yui-min.js"></script>
</head>
<body>

<div id="doc">
    <header class="main-header">
        <div class="content">
            <div class="project-title">
                    <h1 class="project-name">wpapi</h1> <span class="project-version">1.0.2</span>
                    <p class="description">An isomorphic JavaScript client for interacting with the WordPress REST API</p>
            </div>
            <ul class="jump-links">
                <li><a href="#index" class="index-jump-link">index</a></li>
                <li><a href="#top" class="top-jump-link">top</a></li>
            </ul>
        </div>
    </header>
    <div id="bd" class="main-body">

        <div id="docs-sidebar" class="sidebar apidocs">
            <div id="api-list">
                <div id="api-tabview" class="tabview">
                    <ul class="tabs">
                        <li><a href="#api-classes">Classes</a></li>
                        <li><a href="#api-modules">Modules</a></li>
                    </ul>
            
                    <div id="api-tabview-filter">
                        <input type="search" id="api-filter" placeholder="Type to filter APIs">
                    </div>
            
                    <div id="api-tabview-panel">
                        <ul id="api-classes" class="apis classes">
                            <li><a class="type" href="../classes/WPAPI.html">WPAPI</a></li>
                            <li><a class="type" href="../classes/WPRequest.html">WPRequest</a></li>
                        </ul>
            
                        <ul id="api-modules" class="apis modules">
                            <li><a class="module" href="../modules/autodiscovery.html">autodiscovery</a></li>
                            <li><a class="module" href="../modules/filters.html">filters</a></li>
                            <li><a class="module" href="../modules/http-transport.html">http-transport</a></li>
                            <li><a class="module" href="../modules/object-reduce.html">object-reduce</a></li>
                            <li><a class="module" href="../modules/parseRouteString.html">parseRouteString</a></li>
                            <li><a class="module" href="../modules/WPAPI.html">WPAPI</a></li>
                            <li><a class="module" href="../modules/WPRequest.html">WPRequest</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="docs-main" class="apidocs">
            <div class="content container">
                <h1 class="file-heading">File: lib/wp-register-route.js</h1>
                
                <div class="file">
                    <pre class="code prettyprint linenums">
                &#x27;use strict&#x27;;
                
                var extend = require( &#x27;node.extend&#x27; );
                
                var buildRouteTree = require( &#x27;./route-tree&#x27; ).build;
                var generateEndpointFactories = require( &#x27;./endpoint-factories&#x27; ).generate;
                var paramSetter = require( &#x27;./util/parameter-setter&#x27; );
                var applyMixin = require( &#x27;./util/apply-mixin&#x27; );
                var mixins = require( &#x27;./mixins&#x27; );
                
                /**
                 * Create and return a handler for an arbitrary WP REST API endpoint.
                 *
                 * The first two parameters mirror &#x60;register_rest_route&#x60; in the REST API
                 * codebase:
                 *
                 * @class WPAPI
                 * @method registerRoute
                 * @param {string}   namespace         A namespace string, e.g. &#x27;myplugin/v1&#x27;
                 * @param {string}   restBase          A REST route string, e.g. &#x27;/author/(?P&lt;id&gt;\d+)&#x27;
                 * @param {object}   [options]         An (optional) options object
                 * @param {object}   [options.mixins]  A hash of functions to apply as mixins
                 * @param {string[]} [options.methods] An array of methods to whitelist (on the leaf node only)
                 * @returns {Function} An endpoint handler factory function for the
                 * specified route
                 */
                function registerRoute( namespace, restBase, options ) {
                	// Support all methods until requested to do otherwise
                	var supportedMethods = [ &#x27;head&#x27;, &#x27;get&#x27;, &#x27;patch&#x27;, &#x27;put&#x27;, &#x27;post&#x27;, &#x27;delete&#x27; ];
                
                	if ( options &amp;&amp; Array.isArray( options.methods ) ) {
                		// Permit supported methods to be specified as an array
                		supportedMethods = options.methods.map(function( method ) {
                			return method.trim().toLowerCase();
                		});
                	} else if ( options &amp;&amp; typeof options.methods === &#x27;string&#x27; ) {
                		// Permit a supported method to be specified as a string
                		supportedMethods = [ options.methods.trim().toLowerCase() ];
                	}
                
                	// Ensure that if GET is supported, then HEAD is as well, and vice-versa
                	if ( supportedMethods.indexOf( &#x27;get&#x27; ) !== -1 &amp;&amp; supportedMethods.indexOf( &#x27;head&#x27; ) === -1 ) {
                		supportedMethods.push( &#x27;head&#x27; );
                	} else if ( supportedMethods.indexOf( &#x27;head&#x27; ) !== -1 &amp;&amp; supportedMethods.indexOf( &#x27;get&#x27; ) === -1 ) {
                		supportedMethods.push( &#x27;get&#x27; );
                	}
                
                	var fullRoute = namespace
                		// Route should always have preceding slash
                		.replace( /^[\s/]*/, &#x27;/&#x27; )
                		// Route should always be joined to namespace with a single slash
                		.replace( /[\s/]*$/, &#x27;/&#x27; ) + restBase.replace( /^[\s/]*/, &#x27;&#x27; );
                
                	var routeObj = {};
                	routeObj[ fullRoute ] = {
                		namespace: namespace,
                		methods: supportedMethods
                	};
                
                	// Go through the same steps used to bootstrap the client to parse the
                	// provided route out into a handler request method
                	var routeTree = buildRouteTree( routeObj );
                	// Parse the mock route object into endpoint factories
                	var endpointFactories = generateEndpointFactories( routeTree )[ namespace ];
                	var EndpointRequest = endpointFactories[ Object.keys( endpointFactories )[ 0 ] ].Ctor;
                
                	if ( options &amp;&amp; options.params ) {
                		options.params.forEach(function( param ) {
                			// Only accept string parameters
                			if ( typeof param !== &#x27;string&#x27; ) {
                				return;
                			}
                
                			// If the parameter can be mapped to a mixin, apply that mixin
                			if ( typeof mixins[ param ] === &#x27;object&#x27; ) {
                				Object.keys( mixins[ param ] ).forEach(function( key ) {
                					applyMixin( EndpointRequest.prototype, key, mixins[ param ][ key ] );
                				});
                				return;
                			}
                
                			// Attempt to create a simple setter for any parameters for which
                			// we do not already have a custom mixin
                			applyMixin( EndpointRequest.prototype, param, paramSetter( param ) );
                		});
                	}
                
                	// Set any explicitly-provided object mixins
                	if ( options &amp;&amp; typeof options.mixins === &#x27;object&#x27; ) {
                
                		// Set any specified mixin functions on the response
                		Object.keys( options.mixins ).forEach(function( key ) {
                			applyMixin( EndpointRequest.prototype, key, options.mixins[ key ] );
                		});
                	}
                
                	function endpointFactory( options ) {
                		/* jshint validthis:true */
                		options = options || {};
                		options = extend( options, this &amp;&amp; this._options );
                		return new EndpointRequest( options );
                	}
                	endpointFactory.Ctor = EndpointRequest;
                
                	return endpointFactory;
                }
                
                module.exports = registerRoute;
                
                    </pre>
                </div>
            </div>
        </div>

    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/vendor/jquery.min.js"></script>
<script src="../assets/js/jquery-offscreen-trigger.js"></script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
